<section class="break-detail" *ngIf="breakItem as active; else noBreak">
  <h3>Break {{ active.id }}</h3>
  <div class="break-meta">
    <span class="meta-chip" *ngFor="let entry of classificationEntries">
      <strong>{{ formatClassificationKey(entry.key) }}:</strong> {{ entry.value || 'â€”' }}
    </span>
    <span class="meta-chip" *ngIf="classificationEntries.length === 0">
      <strong>Classifications:</strong> Not available
    </span>
    <span class="meta-chip"><strong>Break type:</strong> {{ active.breakType }}</span>
    <span class="meta-chip"><strong>Status:</strong> {{ active.status }}</span>
    <span class="meta-chip"><strong>Detected:</strong> {{ active.detectedAt | date: 'short' }}</span>
  </div>

  <p class="missing-sources" *ngIf="active.missingSources?.length">
    Missing data from: {{ active.missingSources.join(', ') }}
  </p>

  <table class="source-table" *ngIf="fieldKeys.length > 0 && sourceKeys.length > 0; else noFields">
    <thead>
      <tr>
        <th>Field</th>
        <th *ngFor="let source of sourceKeys">{{ formatSourceLabel(source) }}</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let key of fieldKeys">
        <td>{{ key }}</td>
        <td
          *ngFor="let source of sourceKeys"
          [class.different]="isDifferent(key)"
        >
          {{ displayValue(valueFor(source, key)) }}
        </td>
      </tr>
    </tbody>
  </table>
  <ng-template #noFields>
    <p class="empty-source">No field level detail available for the selected break.</p>
  </ng-template>

  <div class="commentary">
    <h4>Commentary</h4>
    <ul>
      <li *ngFor="let comment of active.comments">
        <span class="timestamp">{{ comment.createdAt | date: 'short' }}</span>
        <strong>{{ comment.actorDn }}</strong>
        <em>{{ comment.action }}</em>
        <p>{{ comment.comment }}</p>
      </li>
    </ul>
    <form (ngSubmit)="submitComment()" class="comment-form">
      <label>
        Action code
        <input type="text" [(ngModel)]="commentAction" name="action" required />
      </label>
      <label>
        Comment
        <textarea [(ngModel)]="commentText" name="comment" rows="3" required></textarea>
      </label>
      <button type="submit">Add comment</button>
    </form>
    <div class="status-buttons">
      <ng-container *ngIf="statusOptions.length > 0; else noActions">
        <button type="button" *ngFor="let status of statusOptions" (click)="changeStatus(status)">
          {{ getStatusText(status) }}
        </button>
      </ng-container>
    </div>
    <ng-template #noActions>
      <p class="no-actions">No workflow actions available for your role.</p>
    </ng-template>
  </div>
</section>
<ng-template #noBreak>
  <p class="empty-state">Select a break to review details.</p>
</ng-template>
