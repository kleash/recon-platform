<form class="wizard" [formGroup]="form" (ngSubmit)="save()">
  <header class="wizard-header">
    <h2>{{ mode === 'edit' ? 'Edit reconciliation' : 'Create reconciliation' }}</h2>
    <p>Step {{ currentStep + 1 }} of {{ steps.length }} · {{ steps[currentStep]?.label }}</p>
  </header>

  <ol class="wizard-steps">
    <li
      *ngFor="let step of steps; let i = index"
      [class.active]="i === currentStep"
      [class.complete]="i < currentStep"
      (click)="goToStep(i)"
    >
      <span class="index">{{ i + 1 }}</span>
      <span class="label">{{ step.label }}</span>
    </li>
  </ol>

  <section class="wizard-body" [ngSwitch]="steps[currentStep]?.key">
    <section *ngSwitchCase="'definition'" [formGroup]="definitionGroup" class="definition-step">
      <label>
        Code
        <input type="text" formControlName="code" placeholder="Unique identifier" />
      </label>
      <label>
        Name
        <input type="text" formControlName="name" placeholder="Human friendly name" />
      </label>
      <label>
        Description
        <textarea formControlName="description" rows="3"></textarea>
      </label>
      <label>
        Owner
        <input type="text" formControlName="owner" placeholder="Primary operations owner" />
      </label>
      <label>
        Notes
        <textarea formControlName="notes" rows="2" placeholder="Optional guidance for admins"></textarea>
      </label>
      <div class="definition-flags">
        <label>
          <input type="checkbox" formControlName="makerCheckerEnabled" /> Enable maker-checker approvals
        </label>
        <label>
          Lifecycle status
          <select formControlName="status">
            <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
          </select>
        </label>
      </div>
      <div class="auto-trigger">
        <label class="checkbox">
          <input type="checkbox" formControlName="autoTriggerEnabled" /> Auto-trigger reconciliation when all sources are present
        </label>
        <div class="auto-trigger-grid" *ngIf="definitionGroup.get('autoTriggerEnabled')?.value">
          <label>
            Cron schedule
            <input type="text" formControlName="autoTriggerCron" placeholder="0 2 * * *" />
          </label>
          <label>
            Timezone
            <input type="text" formControlName="autoTriggerTimezone" placeholder="UTC" />
          </label>
          <label>
            Grace minutes
            <input type="number" formControlName="autoTriggerGraceMinutes" />
          </label>
        </div>
      </div>
    </section>

    <section *ngSwitchCase="'sources'" formArrayName="sources" class="sources-step">
      <article *ngFor="let group of sources.controls; let i = index" [formGroupName]="i" class="source-form">
        <header>
          <h3>Source {{ i + 1 }}</h3>
          <button type="button" class="link" (click)="removeSource(i)" *ngIf="sources.length > 1">Remove</button>
        </header>
        <div class="grid">
          <label>Code<input type="text" formControlName="code" /></label>
          <label>Name<input type="text" formControlName="displayName" /></label>
          <label>
            Adapter
            <select formControlName="adapterType">
              <option *ngFor="let type of adapterTypes" [value]="type">{{ type }}</option>
            </select>
          </label>
          <label class="checkbox">
            <input type="checkbox" formControlName="anchor" /> Anchor source
          </label>
        </div>
        <label>Description<textarea formControlName="description" rows="2"></textarea></label>
        <label>Connection config<textarea formControlName="connectionConfig" rows="2" placeholder="JSON or connection string"></textarea></label>
        <label>Arrival expectation<input type="text" formControlName="arrivalExpectation" placeholder="e.g. Weekdays by 18:00" /></label>
        <div class="grid">
          <label>Timezone<input type="text" formControlName="arrivalTimezone" placeholder="UTC" /></label>
          <label>SLA minutes<input type="number" formControlName="arrivalSlaMinutes" /></label>
        </div>
        <ng-container *ngIf="group.get('adapterType')?.value === 'LLM_DOCUMENT'; else adapterOptionsFallback">
          <div formGroupName="llmOptions" class="llm-options">
            <h4>LLM adapter options</h4>
            <label>Prompt template<textarea formControlName="promptTemplate" rows="4" placeholder="Describe how to extract records from {{document}}"></textarea></label>
            <p class="hint">Use {{document}} for the extracted text and {{schema}} if you reference the JSON schema.</p>
            <label>JSON schema<textarea formControlName="extractionSchema" rows="4" placeholder="{ &quot;type&quot;: &quot;array&quot;, ... }"></textarea></label>
            <label>Record path<input type="text" formControlName="recordPath" placeholder="e.g. records" /></label>
            <div class="grid">
              <label>Model<input type="text" formControlName="model" placeholder="Defaults to backend setting" /></label>
              <label>Temperature<input type="number" formControlName="temperature" step="0.1" /></label>
              <label>Max output tokens<input type="number" formControlName="maxOutputTokens" /></label>
            </div>
            <p class="hint">Adapter options are stored as JSON automatically.</p>
          </div>
        </ng-container>
        <ng-template #adapterOptionsFallback>
          <label>Adapter options<textarea formControlName="adapterOptions" rows="2" placeholder="Adapter-specific options (JSON)"></textarea></label>
        </ng-template>
      </article>
      <button type="button" class="secondary" (click)="addSource()">Add source</button>
    </section>

    <section *ngSwitchCase="'schema'" formArrayName="sources" class="schema-step">
      <header class="schema-summary">
        <h3>Define source schemas</h3>
        <p>
          Upload representative files to auto-populate columns for each source, then refine field names, data types,
          and requirements. These columns power transformation previews and matching rules.
        </p>
      </header>

      <article
        *ngFor="let sourceGroup of sources.controls; let i = index"
        [formGroupName]="i"
        class="schema-card"
      >
        <header class="schema-card-header">
          <div>
            <h4>{{ sourceGroup.get('displayName')?.value || ('Source ' + (i + 1)) }}</h4>
            <p class="hint">Code: {{ sourceGroup.get('code')?.value || 'unset' }}</p>
          </div>
          <div class="schema-actions">
            <button
              type="button"
              class="secondary"
              (click)="inferSchemaFromFile(i)"
              [disabled]="sourcePreviewState[i]?.schemaUploading"
            >
              {{ sourcePreviewState[i]?.schemaUploading ? 'Inferring…' : 'Infer schema from file' }}
            </button>
          </div>
        </header>

        <div class="schema-upload-grid">
          <label>
            File type
            <span class="info-icon" title="Select the format of the uploaded sample file.">i</span>
            <select
              [value]="sourcePreviewState[i]?.fileType"
              (change)="setSourcePreviewOption(i, 'fileType', $any($event.target).value)"
            >
              <option value="CSV">CSV</option>
              <option value="DELIMITED">DELIMITED</option>
              <option value="EXCEL">EXCEL</option>
              <option value="JSON">JSON</option>
              <option value="XML">XML</option>
            </select>
          </label>
          <label *ngIf="['CSV','DELIMITED','EXCEL'].includes(sourcePreviewState[i]?.fileType ?? '')" class="checkbox">
            <input
              type="checkbox"
              [checked]="sourcePreviewState[i]?.hasHeader"
              (change)="setSourcePreviewOption(i, 'hasHeader', $any($event.target).checked)"
            />
            Has header row
          </label>
          <label *ngIf="['CSV','DELIMITED'].includes(sourcePreviewState[i]?.fileType ?? '')">
            Delimiter
            <span class="info-icon" title="Single character separating values in the file.">i</span>
            <input
              type="text"
              maxlength="1"
              [value]="sourcePreviewState[i]?.delimiter || ','"
              (input)="setSourcePreviewOption(i, 'delimiter', $any($event.target).value)"
            />
          </label>
          <label *ngIf="sourcePreviewState[i]?.fileType === 'EXCEL'">
            Sheet name
            <input
              type="text"
              [value]="sourcePreviewState[i]?.sheetName || ''"
              (input)="setSourcePreviewOption(i, 'sheetName', $any($event.target).value)"
            />
          </label>
          <label *ngIf="sourcePreviewState[i]?.fileType === 'EXCEL'">
            Sheet selection
            <select multiple (change)="onSheetSelectionChange(i, $event)">
              <option
                *ngFor="let name of sourcePreviewState[i]?.availableSheetNames ?? []"
                [selected]="sourcePreviewState[i]?.sheetNames?.includes(name)"
                [value]="name"
              >
                {{ name }}
              </option>
            </select>
            <div class="inline-actions">
              <label class="checkbox">
                <input
                  type="checkbox"
                  [checked]="sourcePreviewState[i]?.includeAllSheets"
                  (change)="setSourcePreviewOption(i, 'includeAllSheets', $any($event.target).checked)"
                />
                Include all sheets
              </label>
              <button
                type="button"
                class="link"
                (click)="fetchSheetNames(i)"
                [disabled]="sourcePreviewState[i]?.sheetNamesLoading"
              >
                {{ sourcePreviewState[i]?.sheetNamesLoading ? 'Refreshing…' : 'Refresh list' }}
              </button>
            </div>
          </label>
          <label *ngIf="sourcePreviewState[i]?.fileType === 'EXCEL' && sourcePreviewState[i]?.includeSheetNameColumn">
            Sheet name column
            <input
              type="text"
              placeholder="_sheet"
              [value]="sourcePreviewState[i]?.sheetNameColumn || ''"
              (input)="setSourcePreviewOption(i, 'sheetNameColumn', $any($event.target).value)"
            />
          </label>
          <label *ngIf="['JSON','XML'].includes(sourcePreviewState[i]?.fileType ?? '')">
            Record path
            <span class="info-icon" title="Dot notation path to the array of records in the JSON or XML payload.">i</span>
            <input
              type="text"
              placeholder="e.g. data.items"
              [value]="sourcePreviewState[i]?.recordPath || ''"
              (input)="setSourcePreviewOption(i, 'recordPath', $any($event.target).value)"
            />
          </label>
          <label>
            Encoding
            <input
              type="text"
              placeholder="UTF-8"
              [value]="sourcePreviewState[i]?.encoding || ''"
              (input)="setSourcePreviewOption(i, 'encoding', $any($event.target).value)"
            />
          </label>
          <label>
            Max rows
            <input
              type="number"
              min="1"
              max="50"
              [value]="sourcePreviewState[i]?.limit"
              (input)="setSourcePreviewOption(i, 'limit', Number($any($event.target).value))"
            />
          </label>
          <label *ngIf="['CSV','DELIMITED','EXCEL'].includes(sourcePreviewState[i]?.fileType ?? '')">
            Skip rows
            <input
              type="number"
              min="0"
              max="500"
              [value]="sourcePreviewState[i]?.skipRows || 0"
              (input)="setSourcePreviewOption(i, 'skipRows', Number($any($event.target).value))"
            />
          </label>
          <label class="file-input">
            Sample file
            <input type="file" (change)="onSourceSampleFileSelected(i, $event)" />
          </label>
        </div>

        <p class="error" *ngIf="sourcePreviewState[i]?.schemaError">{{ sourcePreviewState[i]?.schemaError }}</p>

        <div class="schema-sample" *ngIf="sourcePreviewState[i]?.schemaSampleRows?.length">
          <h5>Preview rows</h5>
          <pre *ngFor="let row of sourcePreviewState[i]?.schemaSampleRows | slice:0:5">{{ row | json }}</pre>
        </div>

        <section formArrayName="schemaFields" class="schema-fields">
          <header class="schema-fields-header">
            <h5>Fields</h5>
            <p class="hint">
              Edit detected fields or add new ones. These names populate dropdowns in transformations and matching.
            </p>
          </header>
          <div class="schema-fields-table" *ngIf="schemaFieldsArray(i).length > 0; else noSchemaFields">
            <div
              class="schema-field-row"
              *ngFor="let fieldGroup of schemaFieldsArray(i).controls; let f = index"
              [formGroupName]="f"
            >
              <label>
                Column name
                <input
                  type="text"
                  formControlName="name"
                  (input)="onSchemaFieldNameChange(i)"
                  placeholder="e.g. trade_id"
                />
              </label>
              <label>
                Display name
                <input
                  type="text"
                  formControlName="displayName"
                  placeholder="Trade ID"
                />
              </label>
              <label>
                Data type
                <select formControlName="dataType">
                  <option *ngFor="let type of dataTypes" [value]="type">{{ type }}</option>
                </select>
              </label>
              <label class="checkbox">
                <input type="checkbox" formControlName="required" /> Required
              </label>
              <label>
                Description
                <input type="text" formControlName="description" placeholder="Optional context" />
              </label>
              <button type="button" class="link" (click)="removeSchemaField(i, f)" *ngIf="schemaFieldsArray(i).length > 1">
                Remove
              </button>
            </div>
          </div>
          <ng-template #noSchemaFields>
            <p class="hint">No fields defined yet. Add fields manually or infer them from a sample file.</p>
          </ng-template>
          <button type="button" class="secondary" (click)="addSchemaField(i)">Add field</button>
        </section>
      </article>
    </section>

    <section *ngSwitchCase="'transformations'" formArrayName="sources" class="transformations-step">
      <p class="hint">
        Upload sample data or load recent rows to preview how source-level transformations change the dataset
        before canonical mapping.
      </p>
      <article
        *ngFor="let sourceGroup of sources.controls; let i = index"
        [formGroupName]="i"
        class="source-transformation-card"
      >
        <header>
          <h3>{{ sourceGroup.get('displayName')?.value || ('Source ' + (i + 1)) }}</h3>
          <span class="source-code">Code: {{ sourceGroup.get('code')?.value || 'unset' }}</span>
        </header>

        <div formGroupName="transformationPlan" class="plan-section">
          <label class="field">
            <span class="field-label"
              >Dataset Groovy Script
              <span
                class="info-icon"
                title="Optional Groovy executed after column and row operations; mutate the rows list for advanced reshaping. Example: rows.removeIf { it.status == 'IGNORED' }."
                >i</span
              ></span
            >
            <textarea
              formControlName="datasetGroovyScript"
              rows="4"
              placeholder="rows.each { /* mutate records here */ }"
            ></textarea>
          </label>
          <div class="groovy-assistant" *ngIf="getDatasetAssistantState(i) as datasetAssistant">
            <label>
              AI prompt
              <textarea
                rows="2"
                placeholder="Describe the dataset-level transformation to generate"
                [value]="datasetAssistant.prompt"
                (input)="onDatasetGroovyPromptChange(i, $event)"
                [disabled]="datasetAssistant.generating"
              ></textarea>
            </label>
            <div class="groovy-assistant-actions">
              <button
                type="button"
                class="secondary"
                (click)="generateDatasetGroovyScript(i)"
                [disabled]="datasetAssistant.generating"
              >
                {{ datasetAssistant.generating ? 'Generating…' : 'Generate with AI' }}
              </button>
              <span class="hint" *ngIf="datasetAssistant.generating">Gathering column context…</span>
            </div>
            <p class="hint" *ngIf="datasetAssistant.summary && !datasetAssistant.generating">
              {{ datasetAssistant.summary }}
            </p>
            <p class="error" *ngIf="datasetAssistant.error">{{ datasetAssistant.error }}</p>
          </div>

          <section class="operation-group" formArrayName="rowOperations">
            <header>
              <h4>
                Row Operations
                <span
                  class="info-icon"
                  title="Filter, aggregate, or split rows before column derivations. Operations run top to bottom."
                  >i</span
                >
              </h4>
              <button type="button" class="secondary" (click)="addRowOperation(i)">Add row operation</button>
            </header>
            <p class="hint" *ngIf="rowOperations(i).length === 0">
              No row operations configured. Add a rule to filter, aggregate, or split rows.
            </p>
            <div
              *ngFor="let rowGroup of rowOperations(i).controls; let r = index"
              [formGroupName]="r"
              class="operation-card"
            >
              <div class="operation-header">
                <label>
                  Type
                  <span class="info-icon" title="Select the row-level operation to apply.">i</span>
                  <select formControlName="type" (change)="onRowOperationTypeChange(i, r)">
                    <option value="FILTER">FILTER</option>
                    <option value="AGGREGATE">AGGREGATE</option>
                    <option value="SPLIT">SPLIT</option>
                  </select>
                </label>
                <button type="button" class="link" (click)="removeRowOperation(i, r)">Remove</button>
              </div>
              <div class="operation-body" [ngSwitch]="rowGroup.get('type')?.value">
                <div *ngSwitchCase="'FILTER'" formGroupName="filter" class="operation-fields">
                  <label>
                    Column
                    <span class="info-icon" title="Name of the source column used in the comparison.">i</span>
                    <input type="text" formControlName="column" />
                  </label>
                  <label>
                    Mode
                    <span class="info-icon" title="Decide whether matching rows are kept or removed.">i</span>
                    <select formControlName="mode">
                      <option value="RETAIN_MATCHING">RETAIN_MATCHING</option>
                      <option value="EXCLUDE_MATCHING">EXCLUDE_MATCHING</option>
                    </select>
                  </label>
                  <label>
                    Operator
                    <span class="info-icon" title="Comparison operator evaluated against the column value.">i</span>
                    <select formControlName="operator">
                      <option value="EQUALS">EQUALS</option>
                      <option value="NOT_EQUALS">NOT_EQUALS</option>
                      <option value="IN">IN</option>
                      <option value="NOT_IN">NOT_IN</option>
                      <option value="GREATER_THAN">GREATER_THAN</option>
                      <option value="GREATER_OR_EQUAL">GREATER_OR_EQUAL</option>
                      <option value="LESS_THAN">LESS_THAN</option>
                      <option value="LESS_OR_EQUAL">LESS_OR_EQUAL</option>
                      <option value="IS_BLANK">IS_BLANK</option>
                      <option value="IS_NOT_BLANK">IS_NOT_BLANK</option>
                    </select>
                  </label>
                  <label>
                    Value
                    <span class="info-icon" title="Single comparison value when using operators other than IN/NOT_IN.">i</span>
                    <input type="text" formControlName="value" />
                  </label>
                  <label>
                    Values
                    <span class="info-icon" title="Comma separated list used for IN/NOT_IN comparisons.">i</span>
                    <input type="text" formControlName="valuesText" />
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" formControlName="caseInsensitive" /> Case insensitive
                  </label>
                </div>
                <div *ngSwitchCase="'AGGREGATE'" formGroupName="aggregate" class="operation-fields">
                  <label>
                    Group by columns
                    <span class="info-icon" title="Comma separated list of columns used to group rows.">i</span>
                    <input type="text" formControlName="groupByText" />
                  </label>
                  <label>
                    Retain columns
                    <span class="info-icon" title="Columns copied from the first row in each group before aggregations.">i</span>
                    <input type="text" formControlName="retainColumnsText" />
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" formControlName="sortByGroup" /> Sort result by group keys
                  </label>
                  <div formArrayName="aggregations" class="aggregation-list">
                    <div
                      *ngFor="let aggGroup of aggregationsFor(i, r).controls; let a = index"
                      [formGroupName]="a"
                      class="aggregation-row"
                    >
                      <label>
                        Source column
                        <span class="info-icon" title="Column aggregated across the group.">i</span>
                        <input type="text" formControlName="sourceColumn" />
                      </label>
                      <label>
                        Result column
                        <span class="info-icon" title="Name of the column written to the aggregated dataset.">i</span>
                        <input type="text" formControlName="resultColumn" />
                      </label>
                      <label>
                        Function
                        <span class="info-icon" title="Aggregation applied to the source column.">i</span>
                        <select formControlName="function">
                          <option *ngFor="let fn of ['SUM','AVG','MIN','MAX','COUNT','FIRST','LAST']" [value]="fn">
                            {{ fn }}
                          </option>
                        </select>
                      </label>
                      <label>
                        Scale
                        <span class="info-icon" title="Optional decimal places for numeric aggregations.">i</span>
                        <input type="number" formControlName="scale" />
                      </label>
                      <label>
                        Rounding
                        <span class="info-icon" title="Rounding mode applied when scale is set.">i</span>
                        <select formControlName="roundingMode">
                          <option *ngFor="let mode of ['UP','DOWN','CEILING','FLOOR','HALF_UP','HALF_DOWN','HALF_EVEN']" [value]="mode">
                            {{ mode }}
                          </option>
                        </select>
                      </label>
                      <button type="button" class="link" (click)="removeAggregation(i, r, a)">Remove aggregation</button>
                    </div>
                    <button type="button" class="secondary" (click)="addAggregation(i, r)">
                      Add aggregation
                    </button>
                  </div>
                </div>
                <div *ngSwitchCase="'SPLIT'" formGroupName="split" class="operation-fields">
                  <label>
                    Source column
                    <span class="info-icon" title="Column whose value will be split into multiple rows.">i</span>
                    <input type="text" formControlName="sourceColumn" />
                  </label>
                  <label>
                    Target column
                    <span class="info-icon" title="Column receiving the split value; defaults to source column.">i</span>
                    <input type="text" formControlName="targetColumn" />
                  </label>
                  <label>
                    Delimiter
                    <span class="info-icon" title="Character used to split the source column.">i</span>
                    <input type="text" formControlName="delimiter" />
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" formControlName="trimValues" /> Trim tokens
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" formControlName="dropEmptyValues" /> Drop empty values
                  </label>
                </div>
              </div>
            </div>
          </section>

          <section class="operation-group" formArrayName="columnOperations">
            <header>
              <h4>
                Column Operations
                <span
                  class="info-icon"
                  title="Create or adjust columns after row processing. Operations run in order."
                  >i</span
                >
              </h4>
              <button type="button" class="secondary" (click)="addColumnOperation(i)">Add column operation</button>
            </header>
            <p class="hint" *ngIf="columnOperations(i).length === 0">
              No column operations configured. Add a rule to derive or adjust columns.
            </p>
            <div
              *ngFor="let columnGroup of columnOperations(i).controls; let c = index"
              [formGroupName]="c"
              class="operation-card"
            >
              <div class="operation-header">
                <label>
                  Type
                  <span class="info-icon" title="Select the column-level operation to apply.">i</span>
                  <select formControlName="type" (change)="onColumnOperationTypeChange(i, c)">
                    <option value="COMBINE">COMBINE</option>
                    <option value="PIPELINE">PIPELINE</option>
                    <option value="ROUND">ROUND</option>
                  </select>
                </label>
                <button type="button" class="link" (click)="removeColumnOperation(i, c)">Remove</button>
              </div>
              <div class="operation-body" [ngSwitch]="columnGroup.get('type')?.value">
                <div *ngSwitchCase="'COMBINE'" formGroupName="combine" class="operation-fields">
                  <label>
                    Target column
                    <span class="info-icon" title="Name of the column receiving the combined value.">i</span>
                    <input type="text" formControlName="targetColumn" />
                  </label>
                  <label>
                    Sources
                    <span class="info-icon" title="Comma separated list of source columns to combine.">i</span>
                    <input type="text" formControlName="sourcesText" />
                  </label>
                  <label>
                    Delimiter
                    <span class="info-icon" title="Delimiter inserted between combined values.">i</span>
                    <input type="text" formControlName="delimiter" />
                  </label>
                  <label class="checkbox"><input type="checkbox" formControlName="skipBlanks" /> Skip blanks</label>
                  <label>Prefix<input type="text" formControlName="prefix" /></label>
                  <label>Suffix<input type="text" formControlName="suffix" /></label>
                </div>
                <div *ngSwitchCase="'PIPELINE'" formGroupName="pipeline" class="operation-fields">
                  <label>
                    Target column
                    <span class="info-icon" title="Column written with the pipeline result.">i</span>
                    <input type="text" formControlName="targetColumn" />
                  </label>
                  <label>
                    Source column
                    <span class="info-icon" title="Optional source column when different from target.">i</span>
                    <input type="text" formControlName="sourceColumn" />
                  </label>
                  <div formArrayName="pipelineSteps" class="pipeline-editor">
                    <div
                      *ngFor="let stepGroup of columnPipelineSteps(i, c).controls; let s = index"
                      [formGroupName]="s"
                      class="pipeline-step"
                    >
                      <label>
                        Function
                        <span class="info-icon" title="Pipeline function applied to the working column.">i</span>
                        <select formControlName="function">
                          <option *ngFor="let fn of pipelineFunctionOptions" [value]="fn.value">{{ fn.label }}</option>
                        </select>
                      </label>
                      <div formArrayName="args" class="pipeline-args">
                        <div
                          *ngFor="let argCtrl of columnPipelineStepArgs(i, c, s).controls; let a = index"
                          class="arg-row"
                        >
                          <label>
                            Arg {{ a + 1 }}
                            <input [formControlName]="a" placeholder="Value or {{column}}" />
                          </label>
                          <button
                            type="button"
                            class="link"
                            (click)="removeColumnPipelineArg(i, c, s, a)"
                          >
                            Remove
                          </button>
                        </div>
                        <button
                          type="button"
                          class="secondary"
                          (click)="addColumnPipelineArg(i, c, s)"
                        >
                          Add argument
                        </button>
                      </div>
                      <button
                        type="button"
                        class="link"
                        (click)="removeColumnPipelineStep(i, c, s)"
                        *ngIf="columnPipelineSteps(i, c).length > 1"
                      >
                        Remove step
                      </button>
                    </div>
                    <button type="button" class="secondary" (click)="addColumnPipelineStep(i, c)">
                      Add step
                    </button>
                  </div>
                  <p class="hint">
                    Build the function pipeline step by step. Example: apply <code>TRIM</code> then <code>REPLACE</code>
                    with arguments <code>","</code> and <code>"."</code> to swap decimal separators.
                  </p>
                </div>
                <div *ngSwitchCase="'ROUND'" formGroupName="round" class="operation-fields">
                  <label>
                    Target column
                    <span class="info-icon" title="Name of the column that will hold the rounded value.">i</span>
                    <input type="text" formControlName="targetColumn" />
                  </label>
                  <label>
                    Source column
                    <span class="info-icon" title="Optional source column; defaults to the target column.">i</span>
                    <input type="text" formControlName="sourceColumn" />
                  </label>
                  <label>
                    Scale
                    <span class="info-icon" title="Number of decimal places after rounding.">i</span>
                    <input type="number" formControlName="scale" />
                  </label>
                  <label>
                    Rounding mode
                    <span class="info-icon" title="Rounding strategy applied to numeric values.">i</span>
                    <select formControlName="roundingMode">
                      <option *ngFor="let mode of ['UP','DOWN','CEILING','FLOOR','HALF_UP','HALF_DOWN','HALF_EVEN']" [value]="mode">
                        {{ mode }}
                      </option>
                    </select>
                  </label>
                </div>
              </div>
            </div>
          </section>
        </div>

        <section class="preview-panel">
          <h4>
            Preview
            <span class="info-icon" title="Upload a sample file or load the latest ingested rows, then apply the plan.">i</span>
          </h4>
          <div class="preview-controls">
            <label>
              File type
              <span class="info-icon" title="Select the format of the uploaded sample file.">i</span>
              <select
                [value]="sourcePreviewState[i]?.fileType"
                (change)="setSourcePreviewOption(i, 'fileType', $any($event.target).value)"
              >
                <option value="CSV">CSV</option>
                <option value="DELIMITED">DELIMITED</option>
                <option value="EXCEL">EXCEL</option>
                <option value="JSON">JSON</option>
                <option value="XML">XML</option>
              </select>
            </label>
            <label *ngIf="['CSV','DELIMITED','EXCEL'].includes(sourcePreviewState[i]?.fileType ?? '')">
              <span class="info-icon" title="Enable when the first row of the file contains column headers.">i</span>
              <input
                type="checkbox"
                [checked]="sourcePreviewState[i]?.hasHeader"
                (change)="setSourcePreviewOption(i, 'hasHeader', $any($event.target).checked)"
              />
              Has header
            </label>
            <label *ngIf="['CSV','DELIMITED'].includes(sourcePreviewState[i]?.fileType ?? '')">
              Delimiter
              <span class="info-icon" title="Single character separating values in the file.">i</span>
              <input
                type="text"
                maxlength="1"
                [value]="sourcePreviewState[i]?.delimiter || ','"
                (input)="setSourcePreviewOption(i, 'delimiter', $any($event.target).value)"
              />
            </label>
            <label *ngIf="sourcePreviewState[i]?.fileType === 'EXCEL'">
              Sheet name
              <span
                class="info-icon"
                title="Name of the worksheet to use when a specific sheet is required. Leave blank when selecting from the list below."
                >i</span
              >
              <input
                type="text"
                [value]="sourcePreviewState[i]?.sheetName || ''"
                (input)="setSourcePreviewOption(i, 'sheetName', $any($event.target).value)"
              />
            </label>
            <label *ngIf="sourcePreviewState[i]?.fileType === 'EXCEL'">
              Sheet selection
              <span
                class="info-icon"
                title="Choose one or more worksheets to preview together. Use the refresh action after uploading a workbook to populate the list."
                >i</span
              >
              <select multiple (change)="onSheetSelectionChange(i, $event)">
                <option
                  *ngFor="let name of sourcePreviewState[i]?.availableSheetNames ?? []"
                  [selected]="sourcePreviewState[i]?.sheetNames?.includes(name)"
                  [value]="name"
                >
                  {{ name }}
                </option>
              </select>
              <div class="inline-actions">
                <label class="checkbox">
                  <input
                    type="checkbox"
                    [checked]="sourcePreviewState[i]?.includeAllSheets"
                    (change)="setSourcePreviewOption(i, 'includeAllSheets', $any($event.target).checked)"
                  />
                  Include all sheets
                </label>
                <button
                  type="button"
                  class="link"
                  (click)="fetchSheetNames(i)"
                  [disabled]="sourcePreviewState[i]?.sheetNamesLoading"
                >
                  {{ sourcePreviewState[i]?.sheetNamesLoading ? 'Refreshing…' : 'Refresh sheet list' }}
                </button>
              </div>
              <p class="hint" *ngIf="sourcePreviewState[i]?.sheetNamesLoading">Loading workbook sheets…</p>
              <p class="error" *ngIf="sourcePreviewState[i]?.sheetNamesError">
                {{ sourcePreviewState[i]?.sheetNamesError }}
              </p>
            </label>
            <label *ngIf="sourcePreviewState[i]?.fileType === 'EXCEL'">
              Sheet name column
              <span
                class="info-icon"
                title="Append the sheet name to every preview row to help distinguish rows originating from different worksheets."
                >i</span
              >
              <div class="inline-actions">
                <label class="checkbox">
                  <input
                    type="checkbox"
                    [checked]="sourcePreviewState[i]?.includeSheetNameColumn"
                    (change)="setSourcePreviewOption(i, 'includeSheetNameColumn', $any($event.target).checked)"
                  />
                  Append sheet name
                </label>
                <input
                  *ngIf="sourcePreviewState[i]?.includeSheetNameColumn"
                  type="text"
                  placeholder="_sheet"
                  [value]="sourcePreviewState[i]?.sheetNameColumn || ''"
                  (input)="setSourcePreviewOption(i, 'sheetNameColumn', $any($event.target).value)"
                />
              </div>
            </label>
            <label *ngIf="['JSON','XML'].includes(sourcePreviewState[i]?.fileType ?? '')">
              Record path
              <span class="info-icon" title="Dot notation path to the array of records in the JSON or XML payload.">i</span>
              <input
                type="text"
                placeholder="e.g. data.items"
                [value]="sourcePreviewState[i]?.recordPath || ''"
                (input)="setSourcePreviewOption(i, 'recordPath', $any($event.target).value)"
              />
            </label>
            <label>
              Encoding
              <span class="info-icon" title="Character encoding used when reading the uploaded file.">i</span>
              <input
                type="text"
                placeholder="UTF-8"
                [value]="sourcePreviewState[i]?.encoding || ''"
                (input)="setSourcePreviewOption(i, 'encoding', $any($event.target).value)"
              />
            </label>
            <label>
              Max rows
              <span class="info-icon" title="Limit the number of sample rows used for preview.">i</span>
              <input
                type="number"
                min="1"
                max="50"
                [value]="sourcePreviewState[i]?.limit"
                (input)="setSourcePreviewOption(i, 'limit', Number($any($event.target).value))"
              />
            </label>
            <label *ngIf="['CSV','DELIMITED','EXCEL'].includes(sourcePreviewState[i]?.fileType ?? '')">
              Skip rows
              <span
                class="info-icon"
                title="Number of initial data rows to ignore before previewing transformations. Example: set 2 to skip two introductory lines in the file."
                >i</span
              >
              <input
                type="number"
                min="0"
                max="500"
                [value]="sourcePreviewState[i]?.skipRows || 0"
                (input)="setSourcePreviewOption(i, 'skipRows', Number($any($event.target).value))"
              />
            </label>
            <label>
              Sample file
              <span class="info-icon" title="Upload a representative source file for preview.">i</span>
              <input type="file" (change)="onSourceSampleFileSelected(i, $event)" />
            </label>
          </div>
          <div class="preview-actions">
            <button
              type="button"
              class="secondary"
              (click)="previewSourceFromFile(i)"
              [disabled]="sourcePreviewState[i]?.uploading"
            >
              {{ sourcePreviewState[i]?.uploading ? 'Processing…' : 'Upload & Preview' }}
            </button>
            <button type="button" class="secondary" (click)="loadSourceSampleRows(i)" [disabled]="!definitionId">
              Load recent rows
            </button>
            <button type="button" class="secondary" (click)="applyPlanToPreview(i)">
              Apply plan to current rows
            </button>
          </div>
          <p class="error" *ngIf="sourcePreviewState[i]?.error">{{ sourcePreviewState[i]?.error }}</p>
          <div class="preview-results">
            <div class="preview-column">
              <h5>Raw rows</h5>
              <p class="hint" *ngIf="!(sourcePreviewState[i]?.rawRows?.length)">
                Upload a file or load recent rows to inspect the source data.
              </p>
              <pre *ngFor="let row of sourcePreviewState[i]?.rawRows | slice:0:5">{{ row | json }}</pre>
            </div>
            <div class="preview-column">
              <h5>Transformed rows</h5>
              <p class="hint" *ngIf="!(sourcePreviewState[i]?.transformedRows?.length)">
                Apply the plan to view transformed output.
              </p>
              <pre *ngFor="let row of sourcePreviewState[i]?.transformedRows | slice:0:5">{{ row | json }}</pre>
            </div>
          </div>
        </section>
      </article>
    </section>

    <section *ngSwitchCase="'matching'" formArrayName="canonicalFields" class="matching-step">
      <header class="matching-header">
        <div>
          <h3>Matching rules</h3>
          <p>
            Choose how canonical fields compare across sources. Pick the transformed columns for each source,
            tune matching logic, or flag fields as display-only context.
          </p>
        </div>
        <button type="button" class="secondary" (click)="addCanonicalField()">Add rule</button>
      </header>

      <div class="matching-grid">
        <article
          *ngFor="let fieldGroup of canonicalFields.controls; let i = index"
          [formGroupName]="i"
          class="matching-card"
        >
          <header class="matching-card-header">
            <div class="matching-identifiers">
              <label>
                Display name
                <input type="text" formControlName="displayName" placeholder="e.g. Trade Amount" />
              </label>
              <label>
                Canonical name
                <input type="text" formControlName="canonicalName" placeholder="tradeAmount" />
              </label>
            </div>
            <button
              type="button"
              class="link danger"
              (click)="removeCanonicalField(i)"
              *ngIf="canonicalFields.length > 1"
            >
              Remove
            </button>
          </header>

          <div class="matching-meta">
            <label>
              Role
              <select formControlName="role">
                <option *ngFor="let role of fieldRoles" [value]="role">{{ role }}</option>
              </select>
            </label>
            <label>
              Data type
              <select formControlName="dataType">
                <option *ngFor="let type of dataTypes" [value]="type">{{ type }}</option>
              </select>
            </label>
            <label>
              Match type
              <select
                [value]="matchTypeFor(fieldGroup)"
                (change)="onMatchTypeChange(i, $any($event.target).value)"
              >
                <option *ngFor="let option of matchTypeOptionsFor(fieldGroup)" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </label>
            <label *ngIf="isThresholdMatch(fieldGroup)">
              Threshold (%)
              <input type="number" formControlName="thresholdPercentage" step="0.01" />
            </label>
          </div>

          <div class="matching-formatting" *ngIf="isDateMatch(fieldGroup)">
            <label>
              Display format hint
              <input type="text" formControlName="formattingHint" placeholder="e.g. yyyy-MM-dd" />
            </label>
          </div>

          <div class="source-mappings" formArrayName="mappings">
            <div
              *ngFor="let mappingGroup of sourceMappings(i).controls; let m = index"
              [formGroupName]="m"
              class="mapping-row"
            >
              <div class="mapping-source">
                <label>
                  Source
                  <select formControlName="sourceCode">
                    <option value="">Select source</option>
                    <option *ngFor="let source of sourceOptionList" [value]="source.code">
                      {{ source.label }}
                      <span *ngIf="isAnchorSource(source.code)">(anchor)</span>
                    </option>
                  </select>
                </label>
              </div>
              <div class="mapping-column">
                <label>
                  Column
                  <input
                    type="text"
                    formControlName="sourceColumn"
                    [attr.list]="'columns-' + i + '-' + m"
                    placeholder="Select or type column"
                  />
                  <datalist [id]="'columns-' + i + '-' + m">
                    <option *ngFor="let column of columnsForMapping(i, m)" [value]="column"></option>
                  </datalist>
                </label>
                <p class="hint" *ngIf="columnsForMapping(i, m).length === 0">
                  Define fields in the source schema step or infer them from a sample file to surface column options.
                </p>
              </div>
              <div class="mapping-date" *ngIf="isDateMatch(fieldGroup)">
                <label>
                  Input format
                  <input type="text" formControlName="sourceDateFormat" placeholder="e.g. dd/MM/yyyy" />
                </label>
                <label>
                  Normalized format
                  <input type="text" formControlName="targetDateFormat" placeholder="Defaults to yyyy-MM-dd" />
                </label>
              </div>
              <div class="mapping-actions">
                <button
                  type="button"
                  class="link"
                  (click)="removeMapping(i, m)"
                  *ngIf="sourceMappings(i).length > 1"
                >
                  Remove
                </button>
              </div>
            </div>
            <button type="button" class="secondary" (click)="addMapping(i)">Add source mapping</button>
          </div>
        </article>
      </div>
    </section>

    <section *ngSwitchCase="'reports'" formArrayName="reportTemplates" class="reports-step">
      <article *ngFor="let reportGroup of reportTemplates.controls; let i = index" [formGroupName]="i" class="report-form">
        <header>
          <h3>Report {{ i + 1 }}</h3>
          <button type="button" class="link" (click)="removeReportTemplate(i)">Remove</button>
        </header>
        <label>Name<input type="text" formControlName="name" /></label>
        <label>Description<textarea formControlName="description" rows="2"></textarea></label>
        <div class="report-flags">
          <label><input type="checkbox" formControlName="includeMatched" /> Include matched</label>
          <label><input type="checkbox" formControlName="includeMismatched" /> Include mismatched</label>
          <label><input type="checkbox" formControlName="includeMissing" /> Include missing</label>
          <label><input type="checkbox" formControlName="highlightDifferences" /> Highlight differences</label>
        </div>
        <div formArrayName="columns" class="columns">
          <h4>Columns</h4>
          <div *ngFor="let columnGroup of reportColumns(i).controls; let c = index" [formGroupName]="c" class="column-row">
            <label>Header<input type="text" formControlName="header" /></label>
            <label>
              Source
              <select formControlName="source">
                <option *ngFor="let source of reportSources" [value]="source">{{ source }}</option>
              </select>
            </label>
            <label>Field<input type="text" formControlName="sourceField" /></label>
            <label>Display order<input type="number" formControlName="displayOrder" /></label>
            <label class="checkbox"><input type="checkbox" formControlName="highlightDifferences" /> Highlight</label>
            <button type="button" class="link" (click)="removeReportColumn(i, c)">Remove</button>
          </div>
          <button type="button" class="secondary" (click)="addReportColumn(i)">Add column</button>
        </div>
      </article>
      <button type="button" class="secondary" (click)="addReportTemplate()">Add report template</button>
    </section>

    <section *ngSwitchCase="'access'" formArrayName="accessControlEntries" class="access-step">
      <article *ngFor="let entryGroup of accessControlEntries.controls; let i = index" [formGroupName]="i" class="access-form">
        <header>
          <h3>Entry {{ i + 1 }}</h3>
          <button type="button" class="link" (click)="removeAccessEntry(i)">Remove</button>
        </header>
        <label>LDAP Group<input type="text" formControlName="ldapGroupDn" /></label>
        <label>
          Role
          <select formControlName="role">
            <option *ngFor="let role of accessRoles" [value]="role">{{ role }}</option>
          </select>
        </label>
        <label>Product<input type="text" formControlName="product" placeholder="Optional" /></label>
        <label>Sub-product<input type="text" formControlName="subProduct" placeholder="Optional" /></label>
        <label>Entity<input type="text" formControlName="entityName" placeholder="Optional" /></label>
        <div class="notifications">
          <label class="checkbox"><input type="checkbox" formControlName="notifyOnPublish" /> Notify on publication</label>
          <label class="checkbox"
            ><input type="checkbox" formControlName="notifyOnIngestionFailure" /> Notify on ingestion failure</label
          >
          <label>Notification channel<input type="text" formControlName="notificationChannel" placeholder="Email or webhook" /></label>
        </div>
      </article>
      <button type="button" class="secondary" (click)="addAccessEntry()">Add access entry</button>
    </section>

    <section *ngSwitchCase="'review'" class="review-step">
      <h3>Review summary</h3>
      <div class="review-grid">
        <div>
          <h4>Definition</h4>
          <ul>
            <li><strong>Code:</strong> {{ definitionGroup.get('code')?.value }}</li>
            <li><strong>Name:</strong> {{ definitionGroup.get('name')?.value }}</li>
            <li><strong>Owner:</strong> {{ definitionGroup.get('owner')?.value || 'Not set' }}</li>
            <li><strong>Status:</strong> {{ definitionGroup.get('status')?.value }}</li>
            <li><strong>Maker-checker:</strong> {{ definitionGroup.get('makerCheckerEnabled')?.value ? 'Enabled' : 'Disabled' }}</li>
            <li>
              <strong>Auto-trigger:</strong>
              {{ definitionGroup.get('autoTriggerEnabled')?.value ? 'Enabled' : 'Disabled' }}
              <ng-container *ngIf="definitionGroup.get('autoTriggerEnabled')?.value">
                (cron {{ definitionGroup.get('autoTriggerCron')?.value || 'n/a' }},
                timezone {{ definitionGroup.get('autoTriggerTimezone')?.value || 'n/a' }})
              </ng-container>
            </li>
          </ul>
        </div>
        <div>
          <h4>Sources ({{ sources.length }})</h4>
          <ul>
            <li *ngFor="let group of sources.controls">
              {{ group.get('code')?.value }} · {{ group.get('displayName')?.value }} ({{ group.get('adapterType')?.value }})
              <span *ngIf="group.get('arrivalExpectation')?.value">
                — {{ group.get('arrivalExpectation')?.value }}
              </span>
            </li>
          </ul>
        </div>
        <div>
          <h4>Canonical fields ({{ canonicalFields.length }})</h4>
          <ul>
            <li *ngFor="let group of canonicalFields.controls">
              {{ group.get('canonicalName')?.value }} · {{ group.get('role')?.value }}
            </li>
          </ul>
        </div>
        <div>
          <h4>Reports</h4>
          <ul>
            <li *ngFor="let group of reportTemplates.controls">{{ group.get('name')?.value }}</li>
            <li *ngIf="reportTemplates.length === 0" class="muted">None configured</li>
          </ul>
        </div>
        <div>
          <h4>Access control</h4>
          <ul>
            <li *ngFor="let group of accessControlEntries.controls">
              {{ group.get('ldapGroupDn')?.value }} · {{ group.get('role')?.value }}
            </li>
            <li *ngIf="accessControlEntries.length === 0" class="muted">No access overrides</li>
          </ul>
        </div>
      </div>
      <p class="reminder">Save to publish the latest version for administrators and ETL teams.</p>
    </section>
  </section>

  <div class="wizard-footer">
    <button type="button" class="secondary" (click)="previousStep()" [disabled]="currentStep === 0">Back</button>
    <button
      type="button"
      class="secondary"
      *ngIf="currentStep < steps.length - 1"
      (click)="nextStep()"
    >
      Next
    </button>
    <button
      type="submit"
      class="primary"
      *ngIf="currentStep === steps.length - 1"
      [disabled]="isSaving"
    >
      {{ mode === 'edit' ? 'Update reconciliation' : 'Create reconciliation' }}
    </button>
  </div>

  <p class="error" *ngIf="optimisticLockError">{{ optimisticLockError }}</p>
</form>
